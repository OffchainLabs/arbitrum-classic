/*
* Copyright 2020, Offchain Labs, Inc.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
 */

package arbostest

import (
	"crypto/ecdsa"
	"errors"
	"fmt"
	"log"
	"math/big"
	"strings"
	"testing"

	"github.com/ethereum/go-ethereum/accounts/abi"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"

	"github.com/offchainlabs/arbitrum/packages/arb-avm-cpp/cmachine"
	"github.com/offchainlabs/arbitrum/packages/arb-evm/evm"
	"github.com/offchainlabs/arbitrum/packages/arb-evm/l2message"
	"github.com/offchainlabs/arbitrum/packages/arb-util/arbos"
	"github.com/offchainlabs/arbitrum/packages/arb-util/common"
	"github.com/offchainlabs/arbitrum/packages/arb-util/machine"
	"github.com/offchainlabs/arbitrum/packages/arb-util/value"
	"github.com/offchainlabs/arbitrum/packages/arb-validator-core/arboscontracts"
	"github.com/offchainlabs/arbitrum/packages/arb-validator-core/message"
	"github.com/offchainlabs/arbitrum/packages/arb-validator-core/valprotocol"
)

func runMessage(t *testing.T, mach machine.Machine, msg message.Message, sender common.Address) []*evm.Result {
	chainTime := message.ChainTime{
		BlockNum:  common.NewTimeBlocksInt(0),
		Timestamp: big.NewInt(0),
	}

	inbox := value.NewEmptyTuple()
	inbox = value.NewTuple2(inbox, message.NewInboxMessage(msg, sender, big.NewInt(0), chainTime).AsValue())
	assertion, steps := mach.ExecuteAssertion(1000000000, inbox, 0)
	data, err := value.TestVectorJSON(inbox, assertion.ParseLogs(), assertion.ParseOutMessages())
	if err != nil {
		t.Fatal(err)
	}
	t.Log(string(data))
	t.Log("Ran assertion for", steps, "steps and had", assertion.LogsCount, "logs")
	if mach.CurrentStatus() != machine.Extensive {
		t.Fatal("machine should still be working")
	}
	blockReason := mach.IsBlocked(false)
	if blockReason == nil {
		t.Fatal("machine not blocked")
	}

	if _, ok := blockReason.(machine.InboxBlocked); !ok {
		t.Fatal("Machine blocked for weird reason", blockReason)
	}
	results := make([]*evm.Result, 0)
	for _, avmLog := range assertion.ParseLogs() {
		result, err := evm.NewResultFromValue(avmLog)
		if err != nil {
			t.Fatal(err)
		}
		results = append(results, result)
	}
	return results
}

func runTransaction(t *testing.T, mach machine.Machine, msg l2message.AbstractL2Message, sender common.Address) (*evm.Result, error) {
	results := runMessage(t, mach, message.L2Message{Data: l2message.L2MessageAsData(msg)}, sender)
	if len(results) != 1 {
		return nil, fmt.Errorf("unexpected log count %v", len(results))
	}
	result := results[0]
	if result.ResultCode != evm.ReturnCode {
		return nil, fmt.Errorf("transaction failed unexpectedly %v", result)
	}
	return result, nil
}

func getBalanceCall(t *testing.T, mach machine.Machine, address common.Address) *big.Int {
	info, err := abi.JSON(strings.NewReader(arboscontracts.ArbInfoABI))
	if err != nil {
		t.Fatal(err)
	}

	getBalanceABI := info.Methods["getBalance"]
	getBalanceData, err := getBalanceABI.Inputs.Pack(address)
	if err != nil {
		t.Fatal(err)
	}

	getBalanceSignature, err := hexutil.Decode("0xf8b2cb4f")
	if err != nil {
		t.Fatal(err)
	}

	getBalance := l2message.Call{
		MaxGas:      big.NewInt(1000000000),
		GasPriceBid: big.NewInt(0),
		DestAddress: common.NewAddressFromEth(arbos.ARB_INFO_ADDRESS),
		Data:        append(getBalanceSignature, getBalanceData...),
	}
	balanceResult, err := runTransaction(t, mach, getBalance, common.Address{})
	if err != nil {
		t.Fatal(err)
	}
	vals, err := getBalanceABI.Outputs.UnpackValues(balanceResult.ReturnData)
	if len(vals) != 1 {
		t.Fatal("unexpected tx result")
	}
	val, ok := vals[0].(*big.Int)
	if !ok {
		t.Fatal("unexpected tx result")
	}
	return val
}

func deployContract(t *testing.T, mach machine.Machine, sender common.Address, code []byte) (common.Address, error) {
	constructorTx := l2message.Transaction{
		MaxGas:      big.NewInt(1000000000),
		GasPriceBid: big.NewInt(0),
		SequenceNum: big.NewInt(0),
		DestAddress: common.Address{},
		Payment:     big.NewInt(0),
		Data:        code,
	}

	constructorResult, err := runTransaction(t, mach, constructorTx, sender)
	if err != nil {
		return common.Address{}, err
	}
	if len(constructorResult.ReturnData) != 32 {
		return common.Address{}, errors.New("unexpected constructor result length")
	}
	var contractAddress common.Address
	copy(contractAddress[:], constructorResult.ReturnData[12:])
	return contractAddress, nil
}

func depositEth(t *testing.T, mach machine.Machine, dest common.Address, amount *big.Int) {
	msg := message.Eth{
		Dest:  dest,
		Value: amount,
	}

	depositResults := runMessage(t, mach, msg, dest)
	if len(depositResults) != 0 {
		t.Fatal("deposit should not have had a result")
	}
}

func TestFib(t *testing.T) {
	mach, err := cmachine.New(arbos.Path())
	if err != nil {
		t.Fatal(err)
	}

	fib, err := abi.JSON(strings.NewReader(FibonacciABI))
	if err != nil {
		t.Fatal(err)
	}

	pk, err := crypto.GenerateKey()
	if err != nil {
		t.Fatal(err)
	}

	addr := common.NewAddressFromEth(crypto.PubkeyToAddress(pk.PublicKey))
	chain := common.RandAddress()

	initMsg := message.Init{
		ChainParams: valprotocol.ChainParams{
			StakeRequirement:        big.NewInt(0),
			GracePeriod:             common.TimeTicks{Val: big.NewInt(0)},
			MaxExecutionSteps:       0,
			ArbGasSpeedLimitPerTick: 0,
		},
		Owner:       common.Address{},
		ExtraConfig: []byte{},
	}
	results := runMessage(t, mach, initMsg, chain)
	log.Println(results)

	constructorData, err := hexutil.Decode(FibonacciBin)
	if err != nil {
		t.Fatal(err)
	}

	fibAddress, err := deployContract(t, mach, addr, constructorData)
	if err != nil {
		t.Fatal(err)
	}

	depositEth(t, mach, addr, big.NewInt(1000))

	generateFibABI := fib.Methods["generateFib"]
	generateFibData, err := generateFibABI.Inputs.Pack(big.NewInt(20))
	if err != nil {
		t.Fatal(err)
	}

	generateSignature, err := hexutil.Decode("0x2ddec39b")
	if err != nil {
		t.Fatal(err)
	}

	generateTx := l2message.Transaction{
		MaxGas:      big.NewInt(1000000000),
		GasPriceBid: big.NewInt(0),
		SequenceNum: big.NewInt(1),
		DestAddress: fibAddress,
		Payment:     big.NewInt(300),
		Data:        append(generateSignature, generateFibData...),
	}

	generateResult, err := runTransaction(t, mach, generateTx, addr)
	if err != nil {
		t.Fatal(err)
	}
	if len(generateResult.EVMLogs) != 1 {
		t.Fatal("incorrect log count")
	}
	evmLog := generateResult.EVMLogs[0]
	if evmLog.Address != fibAddress {
		t.Fatal("log came from incorrect address")
	}
	if evmLog.Topics[0].ToEthHash() != fib.Events["TestEvent"].ID {
		t.Fatal("incorrect log topic")
	}
	if hexutil.Encode(evmLog.Data) != "0x0000000000000000000000000000000000000000000000000000000000000014" {
		t.Fatal("incorrect log data")
	}

	getFibABI := fib.Methods["getFib"]
	getFibData, err := getFibABI.Inputs.Pack(big.NewInt(5))
	if err != nil {
		t.Fatal(err)
	}

	getFibSignature, err := hexutil.Decode("0x90a3e3de")
	if err != nil {
		t.Fatal(err)
	}

	getFibTx := l2message.Call{
		MaxGas:      big.NewInt(1000000000),
		GasPriceBid: big.NewInt(0),
		DestAddress: fibAddress,
		Data:        append(getFibSignature, getFibData...),
	}

	getFibResult, err := runTransaction(t, mach, getFibTx, addr)
	if err != nil {
		t.Fatal(err)
	}
	if hexutil.Encode(getFibResult.ReturnData) != "0x0000000000000000000000000000000000000000000000000000000000000008" {
		t.Fatal("getFib had incorrect result")
	}
}
func TestDeposit(t *testing.T) {
	mach, err := cmachine.New(arbos.Path())
	if err != nil {
		t.Fatal(err)
	}

	pk, err := crypto.GenerateKey()
	if err != nil {
		t.Fatal(err)
	}

	addr := common.NewAddressFromEth(crypto.PubkeyToAddress(pk.PublicKey))

	amount := big.NewInt(1000)
	depositEth(t, mach, addr, amount)

	if getBalanceCall(t, mach, addr).Cmp(amount) != 0 {
		t.Fatal("incorrect balance")
	}
}

func TestReddit(t *testing.T) {
	mach, err := cmachine.New(arbos.Path())
	if err != nil {
		t.Fatal(err)
	}
	mach.ExecuteAssertion(1000000000, value.NewEmptyTuple(), 0)

	initMsg := message.Init{
		ChainParams: valprotocol.ChainParams{
			StakeRequirement:        big.NewInt(0),
			GracePeriod:             common.TimeTicks{Val: big.NewInt(0)},
			MaxExecutionSteps:       0,
			ArbGasSpeedLimitPerTick: 0,
		},
		Owner:       common.Address{},
		ExtraConfig: []byte{},
	}
	results := runMessage(t, mach, initMsg, common.RandAddress())
	t.Log(results)

	constructorData, err := hexutil.Decode("0x6080604052615bf1806100136000396000f3fe6080604052600436106101cd576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806306e48538146101d257806306fdde031461023e578063095ea7b3146102ce5780631220e2ff1461034157806318160ddd1461035857806319d58746146103835780631b7d83e5146105685780631c00f07f146105b957806323b872dd1461060a578063395093511461069d578063403f1ffa146107105780635a4528c21461076157806362ad1b83146107b857806370a08231146108dd578063715018a61461094257806374e861d61461095957806380274db7146109b05780638129fc1c14610a4a57806383947ea014610a615780638da5cb5b14610c2f5780638f32d59b14610c86578063959b8c3f14610cb557806395d89b4114610d06578063a457c2d714610d96578063a9059cbb14610e09578063ab89013b14610e7c578063ad61ccd514610fa1578063bdc330cb14611031578063c4d66de8146110c1578063d95b637114611112578063dd62ed3e1461119b578063e06e0e2214611220578063e699e8c3146112c6578063f2fde38b14611317578063fad8b32a14611368578063fc673c4f146113b9578063fe9d9303146114be575b600080fd5b3480156101de57600080fd5b506101e761154e565b6040518080602001828103825283818151815260200191508051906020019060200280838360005b8381101561022a57808201518184015260208101905061020f565b505050509050019250505060405180910390f35b34801561024a57600080fd5b506102536115dc565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610293578082015181840152602081019050610278565b50505050905090810190601f1680156102c05780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156102da57600080fd5b50610327600480360360408110156102f157600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061167e565b604051808215151515815260200191505060405180910390f35b34801561034d57600080fd5b5061035661169c565b005b34801561036457600080fd5b5061036d6116bb565b6040518082815260200191505060405180910390f35b34801561038f57600080fd5b50610566600480360360e08110156103a657600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019064010000000081111561042357600080fd5b82018360208201111561043557600080fd5b8035906020019184600183028401116401000000008311171561045757600080fd5b90919293919293908035906020019064010000000081111561047857600080fd5b82018360208201111561048a57600080fd5b803590602001918460018302840111640100000000831117156104ac57600080fd5b9091929391929390803590602001906401000000008111156104cd57600080fd5b8201836020820111156104df57600080fd5b8035906020019184600183028401116401000000008311171561050157600080fd5b90919293919293908035906020019064010000000081111561052257600080fd5b82018360208201111561053457600080fd5b8035906020019184602083028401116401000000008311171561055657600080fd5b90919293919293905050506116c5565b005b34801561057457600080fd5b506105b76004803603602081101561058b57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611c36565b005b3480156105c557600080fd5b50610608600480360360208110156105dc57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050611f69565b005b34801561061657600080fd5b506106836004803603606081101561062d57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190929190505050611ff1565b604051808215151515815260200191505060405180910390f35b3480156106a957600080fd5b506106f6600480360360408110156106c057600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061210e565b604051808215151515815260200191505060405180910390f35b34801561071c57600080fd5b5061075f6004803603602081101561073357600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506121c1565b005b34801561076d57600080fd5b5061077661234c565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156107c457600080fd5b506108db600480360360a08110156107db57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291908035906020019064010000000081111561084257600080fd5b82018360208201111561085457600080fd5b8035906020019184600183028401116401000000008311171561087657600080fd5b90919293919293908035906020019064010000000081111561089757600080fd5b8201836020820111156108a957600080fd5b803590602001918460018302840111640100000000831117156108cb57600080fd5b9091929391929390505050612376565b005b3480156108e957600080fd5b5061092c6004803603602081101561090057600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061251f565b6040518082815260200191505060405180910390f35b34801561094e57600080fd5b50610957612568565b005b34801561096557600080fd5b5061096e6126a5565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156109bc57600080fd5b50610a34600480360360208110156109d357600080fd5b81019080803590602001906401000000008111156109f057600080fd5b820183602082011115610a0257600080fd5b80359060200191846001830284011164010000000083111715610a2457600080fd5b90919293919293905050506126cf565b6040518082815260200191505060405180910390f35b348015610a5657600080fd5b50610a5f6127f6565b005b348015610a6d57600080fd5b50610bad6004803603610120811015610a8557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff16906020019092919080359060200190640100000000811115610ae257600080fd5b820183602082011115610af457600080fd5b80359060200191846001830284011164010000000083111715610b1657600080fd5b90919293919293908035906020019092919080359060200190929190803590602001909291908035906020019092919080359060200190640100000000811115610b5f57600080fd5b820183602082011115610b7157600080fd5b80359060200191846001830284011164010000000083111715610b9357600080fd5b90919293919293908035906020019092919050505061299a565b6040518083815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610bf3578082015181840152602081019050610bd8565b50505050905090810190601f168015610c205780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b348015610c3b57600080fd5b50610c44612bdb565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b348015610c9257600080fd5b50610c9b612c05565b604051808215151515815260200191505060405180910390f35b348015610cc157600080fd5b50610d0460048036036020811015610cd857600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050612c64565b005b348015610d1257600080fd5b50610d1b612feb565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610d5b578082015181840152602081019050610d40565b50505050905090810190601f168015610d885780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b348015610da257600080fd5b50610def60048036036040811015610db957600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061308d565b604051808215151515815260200191505060405180910390f35b348015610e1557600080fd5b50610e6260048036036040811015610e2c57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919050505061319e565b604051808215151515815260200191505060405180910390f35b348015610e8857600080fd5b50610f9f600480360360a0811015610e9f57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291908035906020019092919080359060200190640100000000811115610f0657600080fd5b820183602082011115610f1857600080fd5b80359060200191846001830284011164010000000083111715610f3a57600080fd5b909192939192939080359060200190640100000000811115610f5b57600080fd5b820183602082011115610f6d57600080fd5b80359060200191846001830284011164010000000083111715610f8f57600080fd5b90919293919293905050506131bc565b005b348015610fad57600080fd5b50610fb661338e565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610ff6578082015181840152602081019050610fdb565b50505050905090810190601f1680156110235780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561103d57600080fd5b506110466133cb565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561108657808201518184015260208101905061106b565b50505050905090810190601f1680156110b35780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b3480156110cd57600080fd5b50611110600480360360208110156110e457600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061346d565b005b34801561111e57600080fd5b506111816004803603604081101561113557600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff1690602001909291905050506135c3565b604051808215151515815260200191505060405180910390f35b3480156111a757600080fd5b5061120a600480360360408110156111be57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613774565b6040518082815260200191505060405180910390f35b34801561122c57600080fd5b506112c46004803603608081101561124357600080fd5b810190808035906020019064010000000081111561126057600080fd5b82018360208201111561127257600080fd5b8035906020019184600183028401116401000000008311171561129457600080fd5b909192939192939080351515906020019092919080359060200190929190803590602001909291905050506137fb565b005b3480156112d257600080fd5b50611315600480360360208110156112e957600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613922565b005b34801561132357600080fd5b506113666004803603602081101561133a57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613d3a565b005b34801561137457600080fd5b506113b76004803603602081101561138b57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190505050613dc2565b005b3480156113c557600080fd5b506114bc600480360360808110156113dc57600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff169060200190929190803590602001909291908035906020019064010000000081111561142357600080fd5b82018360208201111561143557600080fd5b8035906020019184600183028401116401000000008311171561145757600080fd5b90919293919293908035906020019064010000000081111561147857600080fd5b82018360208201111561148a57600080fd5b803590602001918460018302840111640100000000831117156114ac57600080fd5b9091929391929390505050614149565b005b3480156114ca57600080fd5b5061154c600480360360408110156114e157600080fd5b81019080803590602001909291908035906020019064010000000081111561150857600080fd5b82018360208201111561151a57600080fd5b8035906020019184600183028401116401000000008311171561153c57600080fd5b9091929391929390505050614297565b005b606060a38054806020026020016040519081016040528092919081815260200182805480156115d257602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311611588575b5050505050905090565b6060609e8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156116745780601f1061164957610100808354040283529160200191611674565b820191906000526020600020905b81548152906001019060200180831161165757829003601f168201915b5050505050905090565b600061169261168b61430a565b8484614379565b6001905092915050565b6116b973d216153c06e857cd7f72665e0af1d7d82172f4946145fa565b565b6000606a54905090565b600060019054906101000a900460ff16806116e457506116e3614855565b5b806116fb57506000809054906101000a900460ff16155b1515611795576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e8152602001807f436f6e747261637420696e7374616e63652068617320616c726561647920626581526020017f656e20696e697469616c697a656400000000000000000000000000000000000081525060400191505060405180910390fd5b60008060019054906101000a900460ff1615905080156117e5576001600060016101000a81548160ff02191690831515021790555060016000806101000a81548160ff0219169083151502179055505b60008989905014151515611887576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260298152602001807f537562726564646974506f696e74733a207375627265646469742063616e277481526020017f20626520656d707479000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b60008787905014151515611929576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260248152602001807f537562726564646974506f696e74733a206e616d652063616e2774206265206581526020017f6d7074790000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b600085859050141515156119cb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f537562726564646974506f696e74733a2073796d626f6c2063616e277420626581526020017f20656d707479000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168c73ffffffffffffffffffffffffffffffffffffffff1614151515611a96576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f537562726564646974506f696e74733a206f776e65722073686f756c64206e6f81526020017f742062652030000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b611a9f8c614866565b611aa88b61346d565b611ab18a6121c1565b8888609d9190611ac2929190615a11565b508686609e9190611ad4929190615a11565b508484609f9190611ae6929190615a11565b50828260a39190611af8929190615a91565b5060008090505b83839050811015611c0657600160a060008686858181101515611b1e57fe5b9050602002013573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508383828181101515611b9a57fe5b9050602002013573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167fb1c266c79163ba5da9a4deba2a5d1313547c94f50a5db49c1d04d9cc24a66c9d60405160405180910390a28080600101915050611aff565b508015611c285760008060016101000a81548160ff0219169083151502179055505b505050505050505050505050565b611c3e612c05565b1515611cb2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614151515611d7d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260308152602001807f537562726564646974506f696e74733a206f70657261746f722061646472657381526020017f732073686f756c646e277420626520300000000000000000000000000000000081525060400191505060405180910390fd5b60a060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16151515611e65576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260288152602001807f537562726564646974506f696e74733a206f70657261746f7220616c7265616481526020017f792065786973747300000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b60a38190806001815401808255809150509060018203906000526020600020016000909192909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050600160a060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055508073ffffffffffffffffffffffffffffffffffffffff167fb1c266c79163ba5da9a4deba2a5d1313547c94f50a5db49c1d04d9cc24a66c9d60405160405180910390a250565b611f71612c05565b1515611fe5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b611fee81614a69565b50565b6000611ffe848484614bdb565b6121038461200a61430a565b6120fe85606060405190810160405280602881526020017f45524332303a207472616e7366657220616d6f756e742065786365656473206181526020017f6c6c6f77616e6365000000000000000000000000000000000000000000000000815250606960008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006120b461430a565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054614f639092919063ffffffff16565b614379565b600190509392505050565b60006121b761211b61430a565b846121b2856069600061212c61430a565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461502590919063ffffffff16565b614379565b6001905092915050565b6121c9612c05565b151561223d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614151515612308576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260358152602001807f537562726564646974506f696e74733a20646973747269627574696f6e436f6e81526020017f74726163742073686f756c64206e6f742062652030000000000000000000000081525060400191505060405180910390fd5b8060a460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600060a460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b600061238061430a565b905061238c81896135c3565b1515612426576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260358152602001807f537562726564646974506f696e74733a2063616c6c6572206973206e6f74206181526020017f6e206f70657261746f7220666f7220686f6c646572000000000000000000000081525060400191505060405180910390fd5b612431888888614bdb565b8673ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f06b541ddaa720db2b10a4d0cdac39b8d360425fc073085fac19bc8261467798789898989896040518086815260200180602001806020018381038352878782818152602001925080828437600081840152601f19601f8201169050808301925050508381038252858582818152602001925080828437600081840152601f19601f82011690508083019250505097505050505050505060405180910390a45050505050505050565b6000606860008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b612570612c05565b15156125e4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff16603360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a36000603360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550565b6000606660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60006126d96126a5565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156127a1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260248152602001807f47534e526563697069656e743a2063616c6c6572206973206e6f742052656c6181526020017f794875620000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b6127ee83838080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050506150af565b905092915050565b600060019054906101000a900460ff16806128155750612814614855565b5b8061282c57506000809054906101000a900460ff16155b15156128c6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e8152602001807f436f6e747261637420696e7374616e63652068617320616c726561647920626581526020017f656e20696e697469616c697a656400000000000000000000000000000000000081525060400191505060405180910390fd5b60008060019054906101000a900460ff161590508015612916576001600060016101000a81548160ff02191690831515021790555060016000806101000a81548160ff0219169083151502179055505b600073ffffffffffffffffffffffffffffffffffffffff16606660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156129765761297561169c565b5b80156129975760008060016101000a81548160ff0219169083151502179055505b50565b60006060808d8d8d8d8d8d8d8d6129af6126a5565b30604051602001808b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018881526020018781526020018681526020018581526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200182810382528a8a82818152602001925080828437600081840152601f19601f8201169050808301925050509b5050505050505050505050506040516020818303038152906040529050606760009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16612b8387878080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050612b7584805190602001206150b6565b61510e90919063ffffffff16565b73ffffffffffffffffffffffffffffffffffffffff161415612bb157612ba7615215565b9250925050612bcb565b612bc5600080811115612bc057fe5b61523a565b92509250505b9b509b9950505050505050505050565b6000603360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6000603360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16612c4861430a565b73ffffffffffffffffffffffffffffffffffffffff1614905090565b8073ffffffffffffffffffffffffffffffffffffffff16612c8361430a565b73ffffffffffffffffffffffffffffffffffffffff1614151515612d35576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602d8152602001807f537562726564646974506f696e74733a20617574686f72697a696e672073656c81526020017f66206173206f70657261746f720000000000000000000000000000000000000081525060400191505060405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff1614151515612e00576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e8152602001807f537562726564646974506f696e74733a206f70657261746f722063616e27742081526020017f686176652030206164647265737300000000000000000000000000000000000081525060400191505060405180910390fd5b60a060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1615612eea5760a26000612e5e61430a565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81549060ff0219169055612f87565b600160a16000612ef861430a565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505b612f8f61430a565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167ff4caeb2d6ca8932a215a353d0703c326ec2d81fc68170f320eb2ab49e9df61f960405160405180910390a350565b6060609f8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156130835780601f1061305857610100808354040283529160200191613083565b820191906000526020600020905b81548152906001019060200180831161306657829003601f168201915b5050505050905090565b600061319461309a61430a565b8461318f85606060405190810160405280602581526020017f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7781526020017f207a65726f0000000000000000000000000000000000000000000000000000008152506069600061310861430a565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054614f639092919063ffffffff16565b614379565b6001905092915050565b60006131b26131ab61430a565b8484614bdb565b6001905092915050565b60a460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166131fd61430a565b73ffffffffffffffffffffffffffffffffffffffff161415156132ae576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252603b8152602001807f537562726564646974506f696e74733a206f6e6c79206469737472696275746981526020017f6f6e20636f6e74726163742063616e206d696e7420706f696e7473000000000081525060400191505060405180910390fd5b6132b8868661525c565b8573ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff167f2fe5be0146f74c5bce36c0b80911af6c7d86ff27e89d5cfa61fc681327954e5d87878787876040518086815260200180602001806020018381038352878782818152602001925080828437600081840152601f19601f8201169050808301925050508381038252858582818152602001925080828437600081840152601f19601f82011690508083019250505097505050505050505060405180910390a350505050505050565b60606040805190810160405280600581526020017f312e302e30000000000000000000000000000000000000000000000000000000815250905090565b6060609d8054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156134635780601f1061343857610100808354040283529160200191613463565b820191906000526020600020905b81548152906001019060200180831161344657829003601f168201915b5050505050905090565b600060019054906101000a900460ff168061348c575061348b614855565b5b806134a357506000809054906101000a900460ff16155b151561353d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e8152602001807f436f6e747261637420696e7374616e63652068617320616c726561647920626581526020017f656e20696e697469616c697a656400000000000000000000000000000000000081525060400191505060405180910390fd5b60008060019054906101000a900460ff16159050801561358d576001600060016101000a81548160ff02191690831515021790555060016000806101000a81548160ff0219169083151502179055505b61359682614a69565b61359e6127f6565b80156135bf5760008060016101000a81548160ff0219169083151502179055505b5050565b60008173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614806136db575060a060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1680156136da575060a260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16155b5b8061376c575060a160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff165b905092915050565b6000606960008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6138036126a5565b73ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156138cb576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260248152602001807f47534e526563697069656e743a2063616c6c6572206973206e6f742052656c6181526020017f794875620000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b61391b85858080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505084848461541b565b5050505050565b61392a612c05565b151561399e576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614151515613a69576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260308152602001807f537562726564646974506f696e74733a206f70657261746f722061646472657381526020017f732073686f756c646e277420626520300000000000000000000000000000000081525060400191505060405180910390fd5b60a060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161515613b50576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260288152602001807f537562726564646974506f696e74733a206f70657261746f7220646f65736e2781526020017f742065786973747300000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b60008090505b60a380549050811015613ca4578173ffffffffffffffffffffffffffffffffffffffff1660a382815481101515613b8957fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415613c9757600160a3805490500381141515613c7b5760a3600160a38054905003815481101515613bf857fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660a382815481101515613c3257fe5b9060005260206000200160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b600160a3805490500360a381613c919190615b31565b50613ca4565b8080600101915050613b56565b5060a060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81549060ff02191690558073ffffffffffffffffffffffffffffffffffffffff167fec42077e4a379228eef9f58422079e786670be900ea3257e9d2e2227d0b56abd60405160405180910390a250565b613d42612c05565b1515613db6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260208152602001807f4f776e61626c653a2063616c6c6572206973206e6f7420746865206f776e657281525060200191505060405180910390fd5b613dbf81615421565b50565b613dca61430a565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614151515613e93576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602a8152602001807f537562726564646974506f696e74733a207265766f6b696e672073656c66206181526020017f73206f70657261746f720000000000000000000000000000000000000000000081525060400191505060405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff1614151515613f5e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e8152602001807f537562726564646974506f696e74733a206f70657261746f722063616e27742081526020017f686176652030206164647265737300000000000000000000000000000000000081525060400191505060405180910390fd5b60a060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff161561405157600160a26000613fbe61430a565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055506140e5565b60a1600061405d61430a565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81549060ff02191690555b6140ed61430a565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f50546e66e5f44d728365dc3908c63bc5cfeeab470722c1677e3073a6ac294aa160405160405180910390a350565b600061415361430a565b905061415f81886135c3565b15156141f9576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260358152602001807f537562726564646974506f696e74733a2063616c6c6572206973206e6f74206181526020017f6e206f70657261746f7220666f7220686f6c646572000000000000000000000081525060400191505060405180910390fd5b61428e81888888888080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505087878080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050506155ac565b50505050505050565b60006142a161430a565b905061430481828686868080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505060206040519081016040528060008152506155ac565b50505050565b6000606660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561436b57339050614376565b6143736156fc565b90505b90565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614151515614444576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260248152602001807f45524332303a20617070726f76652066726f6d20746865207a65726f2061646481526020017f726573730000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415151561450f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260228152602001807f45524332303a20617070726f766520746f20746865207a65726f20616464726581526020017f737300000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b80606960008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925836040518082815260200191505060405180910390a3505050565b6000606660009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16141515156146ec576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e8152602001807f47534e526563697069656e743a206e65772052656c617948756220697320746881526020017f65207a65726f206164647265737300000000000000000000000000000000000081525060400191505060405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16141515156147b6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602d8152602001807f47534e526563697069656e743a206e65772052656c617948756220697320746881526020017f652063757272656e74206f6e650000000000000000000000000000000000000081525060400191505060405180910390fd5b8173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167fb9f84b8e65164b14439ae3620df0a4d8786d896996c0282b683f9d8c08f046e860405160405180910390a381606660006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050565b600080303b90506000811491505090565b600060019054906101000a900460ff16806148855750614884614855565b5b8061489c57506000809054906101000a900460ff16155b1515614936576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602e8152602001807f436f6e747261637420696e7374616e63652068617320616c726561647920626581526020017f656e20696e697469616c697a656400000000000000000000000000000000000081525060400191505060405180910390fd5b60008060019054906101000a900460ff161590508015614986576001600060016101000a81548160ff02191690831515021790555060016000806101000a81548160ff0219169083151502179055505b81603360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550603360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a38015614a655760008060016101000a81548160ff0219169083151502179055505b5050565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614151515614b34576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260398152602001807f47534e526563697069656e745369676e61747572653a2074727573746564207381526020017f69676e657220697320746865207a65726f20616464726573730000000000000081525060400191505060405180910390fd5b80606760006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055507f5553331329228fbd4123164423717a4a7539f6dfa1c3279a923b98fd681a6c7381604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390a150565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614151515614ca6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260258152602001807f45524332303a207472616e736665722066726f6d20746865207a65726f20616481526020017f647265737300000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614151515614d71576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260238152602001807f45524332303a207472616e7366657220746f20746865207a65726f206164647281526020017f657373000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b614e2181606060405190810160405280602681526020017f45524332303a207472616e7366657220616d6f756e742065786365656473206281526020017f616c616e63650000000000000000000000000000000000000000000000000000815250606860008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054614f639092919063ffffffff16565b606860008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550614eb681606860008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461502590919063ffffffff16565b606860008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040518082815260200191505060405180910390a3505050565b60008383111582901515615012576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825283818151815260200191508051906020019080838360005b83811015614fd7578082015181840152602081019050614fbc565b50505050905090810190601f1680156150045780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b5060008385039050809150509392505050565b60008082840190508381101515156150a5576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f536166654d6174683a206164646974696f6e206f766572666c6f77000000000081525060200191505060405180910390fd5b8091505092915050565b6000919050565b60008160405160200180807f19457468657265756d205369676e6564204d6573736167653a0a333200000000815250601c01828152602001915050604051602081830303815290604052805190602001209050919050565b600060418251141515615124576000905061520f565b60008060006020850151925060408501519150606085015160001a90507f7fffffffffffffffffffffffffffffff5d576e7357a4501ddfe92f46681b20a082600190041115615179576000935050505061520f565b601b8160ff16141580156151915750601c8160ff1614155b156151a2576000935050505061520f565b60018682858560405160008152602001604052604051808581526020018460ff1660ff1681526020018381526020018281526020019450505050506020604051602081039080840390855afa1580156151ff573d6000803e3d6000fd5b5050506020604051035193505050505b92915050565b600060606152326020604051908101604052806000815250615774565b915091509091565b6000606082600b01602060405190810160405280600081525091509150915091565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614151515615301576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601f8152602001807f45524332303a206d696e7420746f20746865207a65726f20616464726573730081525060200191505060405180910390fd5b61531681606a5461502590919063ffffffff16565b606a8190555061536e81606860008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205461502590919063ffffffff16565b606860008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040518082815260200191505060405180910390a35050565b50505050565b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16141515156154ec576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260268152602001807f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206181526020017f646472657373000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff16603360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a380603360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6155b68484615784565b8373ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167fa78a9be3a7b862d26933ad85fb11d80ef66b8f972d7cbba06621d583943a4098858585604051808481526020018060200180602001838103835285818151815260200191508051906020019080838360005b83811015615652578082015181840152602081019050615637565b50505050905090810190601f16801561567f5780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b838110156156b857808201518184015260208101905061569d565b50505050905090810190601f1680156156e55780820380516001836020036101000a031916815260200191505b509550505050505060405180910390a35050505050565b600060606000368080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509050600080369050905073ffffffffffffffffffffffffffffffffffffffff81830151169250829250505090565b6000606060008391509150915091565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415151561584f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260218152602001807f45524332303a206275726e2066726f6d20746865207a65726f2061646472657381526020017f730000000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b6158ff81606060405190810160405280602281526020017f45524332303a206275726e20616d6f756e7420657863656564732062616c616e81526020017f6365000000000000000000000000000000000000000000000000000000000000815250606860008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054614f639092919063ffffffff16565b606860008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061595781606a546159c790919063ffffffff16565b606a81905550600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040518082815260200191505060405180910390a35050565b6000615a0983836040805190810160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250614f63565b905092915050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10615a5257803560ff1916838001178555615a80565b82800160010185558215615a80579182015b82811115615a7f578235825591602001919060010190615a64565b5b509050615a8d9190615b5d565b5090565b828054828255906000526020600020908101928215615b20579160200282015b82811115615b1f57823573ffffffffffffffffffffffffffffffffffffffff168260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555091602001919060010190615ab1565b5b509050615b2d9190615b82565b5090565b815481835581811115615b5857818360005260206000209182019101615b579190615b5d565b5b505050565b615b7f91905b80821115615b7b576000816000905550600101615b63565b5090565b90565b615bc291905b80821115615bbe57600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905550600101615b88565b5090565b9056fea165627a7a72305820dd6f6ece62c7fc54393dcecd8040b9f20297c8054c33fd8078c83466828160b70029")
	if err != nil {
		t.Fatal(err)
	}

	redditAddress, err := deployContract(t, mach, common.RandAddress(), constructorData)
	if err != nil {
		t.Fatal(err)
	}
	log.Println(redditAddress)
}

func TestBatch(t *testing.T) {
	chain := common.RandAddress()
	mach, err := cmachine.New(arbos.Path())
	if err != nil {
		t.Fatal(err)
	}

	initMsg := message.Init{
		ChainParams: valprotocol.ChainParams{
			StakeRequirement:        big.NewInt(0),
			GracePeriod:             common.TimeTicks{Val: big.NewInt(0)},
			MaxExecutionSteps:       0,
			ArbGasSpeedLimitPerTick: 0,
		},
		Owner:       common.Address{},
		ExtraConfig: []byte{},
	}
	results := runMessage(t, mach, initMsg, chain)
	log.Println(results)

	constructorData, err := hexutil.Decode(FibonacciBin)
	if err != nil {
		t.Fatal(err)
	}

	dest, err := deployContract(t, mach, common.RandAddress(), constructorData)
	if err != nil {
		t.Fatal(err)
	}
	batchSize := 21
	senders := make([]common.Address, 0, batchSize)
	pks := make([]*ecdsa.PrivateKey, 0)
	for i := 0; i < batchSize; i++ {
		pk, err := crypto.GenerateKey()
		if err != nil {
			t.Fatal(err)
		}
		addr := common.NewAddressFromEth(crypto.PubkeyToAddress(pk.PublicKey))
		depositResults := runMessage(
			t,
			mach,
			message.Eth{
				Dest:  addr,
				Value: big.NewInt(1000),
			},
			addr,
		)
		if len(depositResults) != 0 {
			t.Fatal("deposit should not have had a result")
		}
		pks = append(pks, pk)
	}
	batchSender := common.NewAddressFromEth(crypto.PubkeyToAddress(pks[0].PublicKey))
	txes := make([]l2message.AbstractL2Message, 0)
	hashes := make([]common.Hash, 0)
	batchSenderSeq := int64(0)
	for i := 0; i < 10; i++ {
		tx := l2message.Transaction{
			MaxGas:      big.NewInt(100000000000),
			GasPriceBid: big.NewInt(0),
			SequenceNum: big.NewInt(batchSenderSeq),
			DestAddress: dest,
			Payment:     big.NewInt(0),
			Data:        []byte{},
		}
		senders = append(senders, batchSender)
		txes = append(txes, tx)
		hashes = append(hashes, tx.MessageID(batchSender, chain))
		batchSenderSeq++
	}
	for _, pk := range pks[1:] {
		tx := types.NewTransaction(0, dest.ToEthAddress(), big.NewInt(0), 100000000000, big.NewInt(0), []byte{})
		signedTx, err := types.SignTx(tx, types.NewEIP155Signer(l2message.ChainAddressToID(chain)), pk)
		if err != nil {
			t.Fatal(err)
		}
		addr := common.NewAddressFromEth(crypto.PubkeyToAddress(pk.PublicKey))
		senders = append(senders, addr)
		txes = append(txes, l2message.NewSignedTransactionFromEth(signedTx))
		hashes = append(hashes, common.NewHashFromEth(signedTx.Hash()))
	}

	msg := l2message.NewTransactionBatchFromMessages(txes)
	results = runMessage(t, mach, message.L2Message{Data: l2message.L2MessageAsData(msg)}, batchSender)
	if len(results) != len(txes) {
		t.Fatal("incorrect result count", len(results), "instead of", len(txes))
	}
	for i, result := range results {
		if result.L1Message.Sender != senders[i] {
			t.Error("l2message had incorrect sender", result.L1Message.Sender, senders[i])
		}
		if result.L1Message.Kind != message.L2Type {
			t.Error("l2message has incorrect type")
		}
		if result.L1Message.MessageID() != hashes[i] {
			t.Error("l2message had incorrect id", result.L1Message.MessageID(), hashes[i])
		}
	}
}
